name: Deploy application

on:
  workflow_run:
    workflows:
    - Test Application
    types:
    - completed

env:
  CD_APP_NAME: "GithubActions"
  CD_GROUP_NAME: "CD-GitActions"

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Create CodeDeploy App
      run: aws deploy create-application \
        --application-name ${{ env.CD_APP_NAME }} \
        --compute-platform "Server" || echo "La aplicaci√≥n ya existe"

    - name: Create Deployment Group
      run: aws deploy create-deployment-group \
        --application-name ${{ env.CD_APP_NAME }} \
        --deployment-group-name ${{ env.CD_GROUP_NAME }} \
        --service-role-arn ${{ env.IAM_ROLE }} \
        --deployment-style deploymentType="IN_PLACE",deploymentOption="WITHOUT_TRAFFIC_CONTROL" \
        --ec2-tag-filters Key=${{ EC2_TAG_KEY }},Value=${{ EC2_TAG_VALUE }},Type="KEY_AND_VALUE" || echo "El grupo ya existe"
        #--deployment-config-name no hace falta ponerlo cuando se quiere emplear el "one-at-a-time", como es el caso

    - name: Create Deployment
      run: aws deploy create-deployment \
        --application-name ${{ env.CD_APP_NAME }} \
        --deployment-group-name ${{ env.CD_GROUP_NAME }} \
        --github-location repository=${{ github.repository }},commitId=${{ github.sha }}
        #--revision revisionType="GitHub",s3Location=,gitHubLocation={repository=${{ env.GITHUB_REPOSITORY }},commitId=${{ env.GITHUB_SHA }}},string=,appSpecContent=